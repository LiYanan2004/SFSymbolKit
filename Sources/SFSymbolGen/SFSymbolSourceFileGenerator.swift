//
//  SFSymbolSourceFileGenerator.swift
//  SFSymbolKit
//
//  Created by LiYanan2004 on 2025/11/9.
//

import Foundation
import SwiftSyntax
import SwiftSyntaxBuilder

package struct SFSymbolSourceFileGenerator {
    package let outputURL: URL
    
    package init(outputURL: URL) {
        self.outputURL = outputURL
    }
    
    package func generate() throws {
        try FileManager.default.createDirectoryIfNecessary(
            for: outputURL.deletingLastPathComponent()
        )
        try sourceFile.description
            .write(to: outputURL, atomically: true, encoding: .utf8)
    }
    
    private var sourceFile: some SyntaxProtocol {
        get throws {
            let header = """
            //
            // \(outputURL.lastPathComponent)
            // Generated by SymbolGenPlugin â€“ do not edit.
            //
            """
            
            return try SourceFileSyntax {
                try StructDeclSyntax("public struct SFSymbol: RawRepresentable, Hashable, Equatable, Sendable") {
                    try VariableDeclSyntax("public var rawValue: String")
                    try InitializerDeclSyntax("""
                    public init(rawValue: String) {
                        self.rawValue = rawValue
                    }
                    """)
                    try sfSymbolMembers
                }
            }
            .with(\.leadingTrivia, Trivia(stringLiteral: header) + Trivia(pieces: [.newlines(1)]))
            .formatted()
        }
    }
    
    private var sfSymbolMembers: [DeclSyntax] {
        get throws {
            SFSymbols_Private.allSymbols.map { symbolName in
                let identifier = symbolName.replacingOccurrences(of: ".", with: "_")
                let validIdentifier = identifier.isValidSwiftIdentifier(for: .variableName)
                let identifierToken = TokenSyntax.identifier(
                    validIdentifier ? identifier : "`\(identifier)`"
                )
                let variable = VariableDeclSyntax(
                    Keyword.let,
                    name: PatternSyntax(
                        IdentifierPatternSyntax(
                            identifier: identifierToken
                        )
                    ),
                    initializer: InitializerClauseSyntax(
                        value: ExprSyntax("SFSymbol(rawValue: \"\(raw: symbolName)\")")
                    )
                ).with(\.modifiers, [.init(name: .keyword(.static))])
                return DeclSyntax(variable)
            }
        }
    }
}
